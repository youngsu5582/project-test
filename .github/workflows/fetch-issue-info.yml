name: Fetch Issue Info

on:
  push:
    branches:
      - 'feat/#*'

jobs:
  createPullRequest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Issue Number
        id: extract
        run: |
          branch_name="${GITHUB_REF#refs/heads/}"
          echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV
          
          if [[ "$branch_name" =~ ^feat/#([0-9]+)$ ]]; then
            issue_number="${BASH_REMATCH[1]}"
            echo "ISSUE_NUMBER=$issue_number" >> $GITHUB_ENV
          else
            exit 1
          fi

      - name: Fetch Issue Details
        run: |
          issue_number="${{ env.ISSUE_NUMBER }}"
          
          # Fetch issue details using GitHub API
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                            -H "Accept: application/vnd.github.v3+json" \
                            "https://api.github.com/repos/${{ github.repository }}/issues/$issue_number")
          
          # Extract issue details
          title=$(echo "$response" | jq -r '.title')
          assignees=$(echo "$response" | jq -r '.assignees[].login' | tr '\n' ', ' | sed 's/, $//')
          labels=$(echo "$response" | jq -r '.labels[].name' | tr '\n' ', ' | sed 's/, $//')
          echo "LABELS=$labels" >> $GITHUB_ENV
          echo "TITLE=$title" >> $GITHUB_ENV
          echo "ASSIGNEES=$assignees" >> $GITHUB_ENV
          
          pr_title="feat: ${title}(#${issue_number})"
          echo "PR_TITLE=$pr_title" >> $GITHUB_ENV

      - name: Generate PR Body
        id: generate-body
        run: |
          issue_number="${{ env.ISSUE_NUMBER }}"
          
          # Create PR body using Here Document
          cat <<EOF > pr_body.txt
  ## ğŸ“Œ ê´€ë ¨ ì´ìŠˆ

  - closed: #${issue_number}

## âœ¨ PR ì„¸ë¶€ ë‚´ìš©

  <!-- ìˆ˜ì •/ì¶”ê°€í•œ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”. -->
  EOF
  
  # Read the content into an environment variable
  pr_body=$(cat pr_body.txt)
  echo "PR_BODY=${pr_body}" >> $GITHUB_ENV

- name: Display Issue Info
  run: |
    echo "Issue Title: ${{ env.TITLE }}"
    echo "Issue Assignees: ${{ env.ASSIGNEES }}"
    echo "Labels: ${{ env.LABELS }}"
    echo "PR TITLE: ${{ env.PR_TITLE }}"
    echo "PR BODY: ${{ env.PR_BODY }}"
    echo "BRANCH : ${{ env.BRANCH_NAME }}"

- name: Create Pull Request
  run: |
    PR_NUMBER=$(gh pr create --base main --head feature-branch --title "${{ env.PR_TITLE }}" --body "${{ env.PR_BODY }}" --json number -q .number)
    echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

- name: Add Labels to Pull Request
  run: |
    # Add labels to the newly created pull request
    gh pr edit ${{ env.PR_NUMBER }} --add-labels ${{ env.LABELS }}
