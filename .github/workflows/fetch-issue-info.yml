name: Fetch Issue Info

on:
  push:
    branches:
      - 'feat/#*'

jobs:
  get-issue-info:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract Issue Number
        id: extract
        run: |
          branch_name="${GITHUB_REF#refs/heads/}"
          if [[ "$branch_name" =~ ^feat/#([0-9]+)$ ]]; then
            issue_number="${BASH_REMATCH[1]}"
            echo "ISSUE_NUMBER=$issue_number" >> $GITHUB_ENV
          else
            exit 1
          fi

      - name: Fetch Issue Details
        run: |
          issue_number="${{ env.ISSUE_NUMBER }}"
          
          # Fetch issue details using GitHub API
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                            -H "Accept: application/vnd.github.v3+json" \
                            "https://api.github.com/repos/${{ github.repository }}/issues/$issue_number")
          
          # Extract issue details
          title=$(echo "$response" | jq -r '.title')
          assignees=$(echo "$response" | jq -r '.assignees[].login' | tr '\n' ', ' | sed 's/, $//')
          labels=$(echo "$response" | jq -r '.labels[].name' | tr '\n' ', ' | sed 's/, $//')

          echo "LABELS=$labels" >> $GITHUB_ENV
          echo "TITLE=$title" >> $GITHUB_ENV
          echo "ASSIGNEES=$assignees" >> $GITHUB_ENV
          
          pr_title="feat: ${title}(${issue_number})
          echo "PR_TITLE=$pr_title" >> $GITHUB_ENV

      - name: Display Issue Info
        run: |
          echo "Issue Title: ${{ env.TITLE }}"
          echo "Issue Assignees: ${{ env.ASSIGNEES }}"
          echo "Labels: ${{ env.LABELS }}"
          echo "PR TITLE: ${{ env.LABELS }}"
