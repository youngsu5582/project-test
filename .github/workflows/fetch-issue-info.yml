name: Fetch Issue Info

on:
  push:
    branches:
      - 'feat/#*'

jobs:
  createPullRequest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Issue Number
        id: extract
        run: |
          branch_name="${GITHUB_REF#refs/heads/}"
          echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV
          
          if [[ "$branch_name" =~ ^feat/#([0-9]+)$ ]]; then
            issue_number="${BASH_REMATCH[1]}"
            echo "ISSUE_NUMBER=$issue_number" >> $GITHUB_ENV
          else
            exit 1
          fi

      - name: Fetch Issue Details
        run: |
          issue_number="${{ env.ISSUE_NUMBER }}"
          
          # Fetch issue details using GitHub API
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                            -H "Accept: application/vnd.github.v3+json" \
                            "https://api.github.com/repos/${{ github.repository }}/issues/$issue_number")
          
          # Extract issue details
          title=$(echo "$response" | jq -r '.title')
          assignees=$(echo "$response" | jq -r '.assignees[].login' | tr '\n' ', ' | sed 's/, $//')
          labels=$(echo "$response" | jq -r '.labels[].name' | tr '\n' ', ' | sed 's/, $//')

          echo "LABELS=$labels" >> $GITHUB_ENV
          echo "TITLE=$title" >> $GITHUB_ENV
          echo "ASSIGNEES=$assignees" >> $GITHUB_ENV
          
          pr_title="feat: ${title}(#${issue_number})"
          echo "PR_TITLE=$pr_title" >> $GITHUB_ENV

      - name: Generate PR Body
        id: generate-body
        run: |
          issue_number="${{ env.ISSUE_NUMBER }}"
          pr_body= "## üìå Í¥ÄÎ†® Ïù¥Ïäà \n \n"
          echo "PR_BODY=${pr_body}" >> $GITHUB_ENV

      - name: Display Issue Info
        run: |
          echo "Issue Title: ${{ env.TITLE }}"
          echo "Issue Assignees: ${{ env.ASSIGNEES }}"
          echo "Labels: ${{ env.LABELS }}"
          echo "PR TITLE: ${{ env.PR_TITLE }}"
          echo "PR BODY: ${{ env.PR_BODY }}"
          echo "BRNACH : ${{ env.BRANCH_NAME }}"

      - name: Create Pull Request
        run: |
          pr_number=$(gh pr create --title "${{ env.PR_TITLE }}" --body "${{ env.PR_BODY }}" --base "develop" --label "${{ env.LABELS }}" | xargs gh pr view --json number -q .number)
          echo "PR_NUMBER=pr_number" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Add Labels to Pull Request
        run: |
          # Add labels to the newly created pull request
          gh pr edit ${{ env.PR_NUMBER }} --add-labels ${{ env.LABELS }}

#        id: cpr
#        uses: peter-evans/create-pull-request@v6
#        with:
#          commit-message: "PR ÏûêÎèô ÏÉùÏÑ±"
#          title: ${{ env.PR_TITLE }}
#          labels: ${{ env.LABELS }}
#          assignees: ${{ env.ASSIGNEES }}
#          body: ${{ env.PR_BODY }}
#          base: develop
#          branch: ${{ env.BRANCH_NAME }}
